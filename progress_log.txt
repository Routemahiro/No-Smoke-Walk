# No-Smoke Walk Osaka - 進捗記録

## 2025-11-10

### 位置情報自動取得設定機能を追加

**実施内容:**
- localStorageで自動取得設定を保存
- トップページにトグルスイッチを追加
- ユーザーが自動/手動を選択可能に
- 毎回の位置情報許可ダイアログを防止

**変更ファイル:**
- frontend/src/hooks/useGeolocation.ts
- frontend/src/components/ReportForm.tsx

**効果:**
- ユーザーの意思で自動取得ON/OFF可能
- 次回訪問時から設定が保持される
- プライバシーに配慮した設計
- 歩きタバコ報告時の利便性向上

**コミット:**
- b571537: feat: 位置情報の自動取得設定を追加

**デプロイ:**
- https://305480d9.no-smoke-walk.pages.dev
- 本番URL: https://no-smoke-alert.com

---

### マップUI改善（案1）実装完了

**実施内容:**
- ヒートマップビューのUI/UX大幅改善
- フィルタ機能の追加
  - 日数フィルタ: 7日/30日/90日/180日の選択ボタン
  - カテゴリフィルタ: すべて/歩きタバコ/立ち止まり喫煙の選択ボタン
- レイアウト改善
  - レジェンドをマップ上部に移動（視認性向上）
  - 凡例・使い方セクションの充実化
- ボタンデザイン改善
  - 現在位置ボタンを大きく目立つデザインに変更（青色、サイズアップ）
  - アクティブなフィルタが視覚的にわかりやすく
- ローディング表示の改善
  - backdrop-blur効果を追加
  - より詳細なメッセージ表示
- 新機能追加
  - アクティブフィルタ表示（マップ上部左に表示）
  - マップサイズを拡大（500px → 600px）
- Google Analytics イベントトラッキング追加
  - フィルタ変更時
  - 現在位置取得時

**変更ファイル:**
- frontend/src/components/HeatmapView.tsx

**効果:**
- ユーザーがデータを柔軟にフィルタリング可能
- より直感的で使いやすいUI
- 視認性の大幅向上
- データ分析がより容易に

**次のステップ（案2検討項目）:**
- パフォーマンス最適化
  - マップレイヤーの更新ロジック改善
  - useEffectの依存関係整理
- バックエンド改善
  - 地理的範囲フィルタリング（userLocation + radius）
  - グリッドサイズの動的調整
- スケーラビリティ向上
  - 大量データへの対応

**コミット:**
- c1f6415: feat: ヒートマップUIの大幅改善（案1実装）

---

**作成日:** 2025-11-10
**作成者:** AI (鈴垣 美影)

---

## 2026-01-07

### 本番Workersのヒートマップ仕様統一（周辺モード対応）

**実施内容:**
- 本番Workers（`backend/src/index.ts` → `backend/src/handlers/heatmap.ts`）の `/api/heatmap` を改善
  - `userLat/userLon` を受け取り、現在地（または表示位置）周辺のデータ取得に対応
  - `radius`（m）で半径フィルタ（デフォルト: 800m）
  - グリッド集約を距離ベース（m）に変更し、過剰な集約（旧: 約1km）を緩和
    - 周辺モード: 75m（デフォルト）
    - 広域モード: 250m（デフォルト）
  - `densityRatio`（周辺内での比率）を返却して、フロントの重み付けが本番でも成立
- backendの型チェックが通るよう、abuse guard更新処理の型を軽微修正

**変更ファイル:**
- backend/src/handlers/heatmap.ts
- backend/src/types/index.ts
- backend/src/handlers/reports.ts

**効果:**
- 「点が集約されすぎて場所が不正確」という課題を、周辺モードで大きく改善
- フロントの `densityRatio` 優先のヒートマップ重み付けが本番でも機能

**コミット:**
- d72765a: feat(backend): improve heatmap aggregation

---

## 2026-01-08

### 引き継ぎ資料/デプロイ状況ドキュメントの整合性メンテ

**実施内容:**
- `docs/sessions/SESSION_HANDOVER_20260108_PART1.md` の「origin/mainよりahead」断言を、`git status -sb` で確認する手順に変更
- 引き継ぎ資料のコミット一覧に `docs: 引き継ぎ資料作成` を追記
- 未追跡だった `DEPLOYMENT_STATUS.md` を追跡してコミット

**変更ファイル:**
- docs/sessions/SESSION_HANDOVER_20260108_PART1.md
- DEPLOYMENT_STATUS.md
- TODO.md

**コミット:**
- 3157cb6: docs: start doc consistency update
- 82f0273: docs: track deployment status
- 80ae8b6: docs: fix handover consistency

---

## 2026-02-03

### 引き継ぎ資料の追記（前提env/依存、simple-server方針の明文化）

**実施内容:**
- `docs/sessions/SESSION_HANDOVER_20260108_PART1.md` に「前提（環境変数/依存）」を追加
- `backend/simple-server.js` の扱いを「原則使わない（Workersに統一）」として結論明記
- `TODO.md` にチェックボックス運用ルールを追記し、当タスクを作業中として追加

**変更ファイル:**
- docs/sessions/SESSION_HANDOVER_20260108_PART1.md
- TODO.md

**コミット:**
- e81d0e3: docs: update TODO
- 34fcb3d: docs: clarify handover prerequisites

---

## 2026-02-03

### 位置情報許可ダイアログ頻発のUX改善（バランス案）+ 周辺デフォルト半径400m

**実施内容:**
- auto-fetch ON のとき、マウント直後に許可ダイアログを出しにいかないように改善
  - 最後に保存した位置を即時採用（localStorage）
  - Permissions API が使えて `granted` の場合のみ、サイレントに位置を更新
- ヒートマップ取得パラメータに `radius` を追加し、周辺モードのデフォルト半径を **400m** に

**変更ファイル:**
- frontend/src/hooks/useGeolocation.ts
- frontend/src/hooks/useHeatmap.ts
- frontend/src/lib/supabase.ts
- TODO.md

**コミット:**
- 9a56bea: docs: update TODO
- 39b4d95: fix(frontend): reduce geolocation prompts

---

## 2026-02-03

### 本番反映（Cloudflare Pages / Workers）

**実施内容:**
- GitHubへ push（複数コミット）
- Cloudflare Pages 手動デプロイ（`no-smoke-walk`）
- Cloudflare Workers 手動デプロイ（`no-smoke-walk-api`）
- ただし **Supabase のプロジェクトURLがDNS解決できない/到達不能**の疑いがあり、Workersの `/api/heatmap` は上流で失敗（`Supabase query failed: 530`）
  - 暫定対応として、フロント側を「上流障害でもデモデータにフォールバック」するように変更して再デプロイ

**デプロイ/確認:**
- Pages preview:
  - https://4a9d6653.no-smoke-walk.pages.dev
  - https://9dbca76c.no-smoke-walk.pages.dev
- 本番ドメイン: https://no-smoke-alert.com
- Workers:
  - https://no-smoke-walk-api.no-smoke-walk.workers.dev/api/health（OK）
  - https://no-smoke-walk-api.no-smoke-walk.workers.dev/api/heatmap（上流障害）

**コミット:**
- 4f4d9dc: fix(frontend): fix permissions api check
- e3ad22c: fix(backend): use service key for heatmap reads
- 4add1f2: fix(backend): surface supabase errors for heatmap
- b40a620: fix(frontend): fallback on upstream heatmap failures